# Telegram-бот для проверки бонусного баланса

Этот проект представляет собой Telegram-бота, разработанный с использованием `FastAPI` и `aiogram`. Бот позволяет пользователям делиться своим номером телефона и получать информацию о бонусном балансе, уровне лояльности и сроке действия бонусов из материализованного представления PostgreSQL.

## Функциональность

*   **Получение контакта:** При команде `/start` бот предлагает пользователю поделиться номером телефона через кнопку.
*   **Проверка авторизации:** Бот проверяет, что предоставленный контакт принадлежит отправителю сообщения.
*   **Поиск данных:** Нормализованный номер телефона используется для поиска в материализованном представлении `bonuses_balance` в базе данных PostgreSQL.
*   **Отображение информации:** Если данные найдены, бот отправляет пользователю:
    *   Имя
    *   Бонусный баланс
    *   Уровень лояльности
    *   Срок действия бонусов (если баланс положительный)
*   **Логирование использования:** Все попытки использования бота (успешные и неудачные) логируются в таблицу `telegram_bot_usage_stats`.
*   **Обработка ошибок:** Бот корректно обрабатывает ошибки и предоставляет пользователю информативные сообщения в случае сбоев.

## Требования

*   Python 3.8 или выше
*   PostgreSQL (для базы данных)
*   Telegram Bot Token (получить у [@BotFather](https://t.me/BotFather) в Telegram)

## Зависимости

Список необходимых Python-пакетов содержится в файле `requirements.txt`:

```txt
fastapi==0.115.0
uvicorn[standard]==0.30.6
aiogram==3.4.1
asyncpg==0.29.0
python-dateutil==2.9.0.post0
aiohttp==3.9.5
pydantic-settings==2.3.4
pydantic==2.8.2

## Переменные окружения

Приложение использует `pydantic-settings` для загрузки настроек из окружения (и опционального файла `.env`).
Доступные переменные:

| Переменная              | Описание                                               | Значение по умолчанию |
|-------------------------|--------------------------------------------------------|-----------------------|
| `TELEGRAM_BOT_TOKEN`    | Токен Telegram-бота                                    | — (обязательно)       |
| `DATABASE_URL`          | Строка подключения к PostgreSQL                        | — (обязательно)       |
| `WEBHOOK_URL`           | URL для установки вебхука                              | отсутствует           |
| `PORT`                  | Порт HTTP-сервера                                      | `8000`                |
| `POOL_MIN_SIZE`         | Минимальный размер пула соединений `asyncpg`           | `1`                   |
| `POOL_MAX_SIZE`         | Максимальный размер пула соединений `asyncpg`          | `10`                  |

`POOL_MIN_SIZE` не может превышать `POOL_MAX_SIZE`. Настройки кэшируются для предотвращения лишних чтений
переменных окружения.
